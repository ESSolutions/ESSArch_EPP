{% extends 'index.html' %}
{% load js staticfiles%}
{% load dictionary_extras %}

{% block content %}

<div style="margin:20px">
<H1>{{ label }}</H1>

<br/>

<div>
  <table class="collaptable table">
    <thead>
      <tr>
                <th>Generation</th>
                <th>Archivist organization</th>
                <th>Label</th>
                <th>Create date</th>
                <th>Start date</th>
                <th>End date</th>
                <th>State</th>
                <th>Activity</th>
                <th>AIC-UUID</th>
                <th>IP-UUID</th>
      </tr>
    </thead>
    <tbody id="AIC-table">
            <tr><td>No IPs</td></tr>
    </tbody>
  </table>
</div>


{% endblock %}
{% block app-extra-script %}
    {% js "aCollapTable/aCollapTable.js" %}
    {% js "controlarea/js/collapsible-aic.js" %}

<script>

var aiccheckresult = false;
var IPJSONlink = "{% url 'ingest_list_info' %}";
//var JSONlink = '/api/aicobjects/?archiveobjects__StatusProcess__lt=3000';
var JSONlink = "{% url 'ingest_list_info' %}";
var createlink = '/ingest/new/';
var info = {};
var tabletext = '';

$.getJSON("{% url 'aiccheck' %}", function(aiccheckresult){
	
	if (aiccheckresult == true ){
		
		AICingestlist(JSONlink,createlink);
	}
	
	else {
		noAICingestlist(JSONlink,createlink);
	}
});

function AICingestlist(JSONlink, createlink){
$(document).ready(function(){
$.getJSON( JSONlink, function(listinfo1) {

	 info = listinfo1;
	 populatelist();
	 //setaichtml(info);
	 
     $('.collaptable').aCollapTable({ 
     startCollapsed: true,
     addColumn: false, 
     plusButton: '<span class="i">+</span>', 
     minusButton: '<span class="i">-</span>' 
    });
});
});
};

function noAICingestlist(IPJSONlink, createlink){
	$(document).ready(function(){
	$.getJSON( IPJSONlink, function(listinfo1) {

	     info = listinfo1;
	     populateIPlist();
	    
	});
	});
	};

function StatusActivityChoices(Activity){
	
	var StatusActivityText = "";
	
    switch(Activity){
  
    case 0:
    	StatusActivityText =  'OK';
    	break;
    case 1:
    	StatusActivityText =  'New object';
    	break;
    case 2:
    	StatusActivityText = 'Receive';
    	break;
    case 3:
    	StatusActivityText = 'Checking';
    	break;
    case 4:
    	StatusActivityText = 'Need of assistance';
    	break;
    case 5:
    	StatusActivityText = 'Progress';
    	break;
    case 6:
    	StatusActivityText = 'Pending writes';
    	break;
    case 7:
    	StatusActivityText = 'ControlArea';
    	break;
    case 8:
    	StatusActivityText = 'WorkArea';
    	break;
    case 100:
    	StatusActivityText = 'FAIL';
    	break;
    default:
    	StatusActivityText = 'Not known';
    	console.log('Activity');
    	console.log(Activity);
    }
	
	return StatusActivityText;
};



function StatusProcessChoices(Process){
       
       var StatusProcessText = "";
       
       switch(Process){
       		case 0:
       			StatusProcessText = 'Ingest';
       			break;
            case 3000:
                StatusProcessText = 'Archived';
                break;
            case 5000:
                StatusProcessText = 'Controlarea';
                break;
            case 5100:
                StatusProcessText = 'Workarea';
                break;
            case 9999:
                StatusProcessText = 'Deleted';
                break;
            default:
                StatusProcessText =' Not known ';
            	console.log('StatusProcess:')
            	console.log(Process);
       }

        return StatusProcessText;
   };

function populatelist(){
    
    if(info.length == 0){
        tabletext = 'List is empty';
    }
    
    for (i = 0; i < info.length; i++){
    tabletext = tabletext 
    + '<tr data-id="' 
    + info[i].AIC_UUID + '" data-parent="">'
    + '<td>AIC</td>'
    + '<td>' + info[i].Archivist_organization + '</td>' 
    + '<td>' + info[i].Label + '</td>' 
    + '<td>' + info[i].create_date +'</td>'
    + '<td>' + info[i].startdate + '</td>'
    + '<td>' + info[i].enddate + '</td>'
    + '<td>' + '</td>'
    + '<td>' + '</td>'
    + '<td>' + info[i].AIC_UUID + '</td>'
    + '</tr>';
    
   var IPList = info[i].IPs
   var AICparent = info[i].AIC_UUID
   
   for (j = 0; j < IPList.length; j++){
   
   var selectlisthtml = '<select id="' + IPList[j].ObjectUUID + '" onchange=setacitivity("' + IPList[j].ObjectUUID + '"'  + ',' + IPList[j].Process +')>'
	   + '<option value="0">OK</option>'
	   + '<option value="1">New object</option>'
	   + '<option value="2">Receive</option>'
	   + '<option value="3">Checking</option>'
	   + '<option value="4">Need of assistance</option>'
	   + '<option value="5">Progress</option>'
	   + '<option value="6">Pending writes</option>'
	   + '<option value="7">ControlArea</option>'
	   + '<option value="8">Workarea</option>'
	   + '<option value="100">FAIL</option>'
	   + '</select>';
   

        tabletext = tabletext
        + '<tr data-id=' + IPList[j].ObjectUUID + ' '
        + 'data-parent=' + AICparent + '>'
        + '<td><a href="'+ createlink + IPList[j].ObjectUUID +'/"> IP_' + IPList[j].Generation + '</a></td>'
        + '<td> ' + IPList[j].Archivist_organization + '</td>'
        + '<td> ' + IPList[j].Label + '</td>'
        + '<td>' + IPList[j].create_date + '</td>'
        + '<td>' + IPList[j].startdate + '</td>'
        + '<td>' + IPList[j].enddate + '</td>'
        + '<td>' + StatusProcessChoices(IPList[j].Process) + ' </td>'
        + '<td>'  + selectlisthtml + '</td>' //StatusActivityChoices(IPList[j].Activity)
        + '<td> ' + AICparent + ' </td>'
        + '<td> ' + IPList[j].ObjectUUID + ' </td>'
        + '</tr>'
    }
    
    
    
        
    }
 document.getElementById("AIC-table").innerHTML = tabletext;
 };

 function setaichtml(ajaxinfo){
	    
	    var aicwrapper = ajaxinfo;
	    
	    console.log('We got info');
	    console.log(ajaxinfo);
	    
	    nextpage = aicwrapper.next;
	    previouspage = aicwrapper.previous;
	    
	    var AIClist = aicwrapper.results;

	    for (i = 0; i < AIClist.length; i++){
	        
	        
	        var IPlist = AIClist[i].archiveobjects;

	        if(IPlist.length > 0){
	                var AIC = AIClist[i];
	                var lastIPcounter = IPlist.length - 1;
	                var lastIP = IPlist[lastIPcounter];
	                var lastIPinfo = lastIP.archiveobjectdata_set[0];
	            
	                tabletext = tabletext
	                + '<tr data-id="' +  AIC.ObjectUUID+ '" data-parent="">'
	                + '<td>AIC</td>'
	                + '<td>'  + lastIP.EntryAgentIdentifierValue + '</td>'
	                + '<td>' + lastIPinfo.label + '</td>'
	                + '<td>' + lastIP.CreateDate + '</td>'
	                + '<td>' + lastIPinfo.startdate + '</td>'
	                + '<td>' + lastIPinfo.enddate + '</td>'
	                + '<td></td>'
	                + '<td>' + AIC.ObjectUUID + '</td>'
	                +'</tr>';
	                
	                var aicparent = AIC.ObjectUUID;
	                //var createlink = '/access/new/';
	                
	                for (j = 0; j < IPlist.length; j++){
	                     
	                    var IP = IPlist[j];
	                    var IPinfo = IP.archiveobjectdata_set[0];
	                    
	                    tabletext = tabletext
	                    + '<tr data-id=' + IP.ObjectUUID + ' ' + 'data-parent=' + aicparent + '>'
	                    + '<td><a href="'+ createlink + IP.ObjectUUID +'/"> IP_' + IP.Generation + '</a></td>'
	                    + '<td>' + IP.EntryAgentIdentifierValue + '</td>'
	                    + '<td>' + IPinfo.label + '</td>'
	                    + '<td>' + IP.CreateDate + '</td>'
	                    + '<td>' + IPinfo.startdate + '</td>'
	                    + '<td>' + IPinfo.enddate + '</td>'
	                    + '<td> ' + StatusProcessChoices(IP.StatusProcess) + ' </td>'
	                    + '<td>' + aicparent + '</td>'
	                    + '<td>' + IP.ObjectUUID + '</td>'
	                    + '</tr>';

	                  	                    
	                }//IPlist for loop
	                
	                
	        }; //End of length test
	    };//End of for aic list for loop
	    
	     console.log(tabletext);
	    document.getElementById("AICtable").innerHTML = tabletext;
	};//End of serAIChtml function
 

 
 
 
 function setacitivity(number, presentactivity){
	 
	 console.log('The function is with us');
	 console.log('IP UUID');
	 //console.log(IPUUID);
	 console.log(number);
	 console.log(presentactivity);
	 var thevalue = document.getElementById(number).value
	 console.log('Selected state');
	 console.log(thevalue);
	 
 }
 
 
 
 function populateIPlist(){
	    
	    if(info.length == 0){
	        tabletext = 'List is empty';
	    }
	    
	    for (i = 0; i < info.length; i++){
	    
	   var IPList = info[i].IPs
	   var AICparent = info[i].AIC_UUID
	   
	   for (j = 0; j < IPList.length; j++){
	        tabletext = tabletext
	        + '<td><a href="'+ createlink + IPList[j].id +'/"> IP_' + IPList[j].Generation + '</a></td>'
	        + '<td> ' + IPList[j].Archivist_organization + ' </td>'
	        + '<td> ' + IPList[j].Label + ' </td>'
	        + '<td> ' + IPList[j].create_date + ' </td>'
	        + '<td> ' + IPList[j].startdate + ' </td>'
	        + '<td> ' + IPList[j].enddate + ' </td>'
	        + '<td> ' + StatusProcessChoices(IPList[j].Process) + ' </td>'
	        + '<td>'  + StatusActivityChoices(IPList[j].Activity) + '</td>'
	        + '<td> ' + AICparent + ' </td>'
	        + '<td> ' + IPList[j].ObjectUUID + ' </td>'
	        + '</tr>'
	    }
	    
	    
	    
	        
	    }
	 document.getElementById("AIC-table").innerHTML = tabletext;
	 };
</script>
{% endblock %}