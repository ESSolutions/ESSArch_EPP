{% extends "admin/base_site.html" %}
{% load js staticfiles%}

{% block content %}
<h1>Overview of controlarea requests</h1>
<br>
Requests from: <input type="text" value="2" size="3" id="numberofdays" > number of days ago.<button onclick=otherdays()>Get requests</button>
<br>
<br>
<b>Failed requests</b>
<br>
<br>
<table class="table">
<thead>
<tr>
<th>Request Status</th>
<th>Type of error</th>
<th>Request Result</th>
</tr>
<tbody id="failedtasks">
<td> No requests</td>
</tbody>
</thead>
</table>
<br>
<b>Pending requests</b>
<br>
<br>
<table class="table">
<thead>
<tr>
<th>Request Status</th>
<th>Request Result</th>
</tr>
<tbody id="pendingtasks">
<td> No requests</td>
</tbody>
</thead>
</table>
<br>
<b>Requests in progress</b>
<br>
<br>
<table class="table">
<thead>
<tr>
<th>Request purpose</th>
<th></th>
<th>User</th>
<th></th>
<th>Request Progress</th>
</tr>
<tbody id="progresstasks">
<td> No requests</td>
</tbody>
</thead>
</table>

<b>Successful requests</b>
<br>
<br>
<table class="table">
<thead>
<tr>
<th>Request Label</th>
<th></th>
<th>Request purpose</th>
<th></th>
<th>User</th>
<th></th>
<th>Request status</th>
<th></th>
<th>Date completed</th>
</tr>
<tbody id="successtasks">
<td> No tasks</td>
</tbody>
</thead>
</table>
{% endblock %}
{% block app-extra-script %}

<script>


var allTasks = {};

var numberofdays = $('#numberofdays').val();
//var numberofdays = 5;

gettasklist();

function gettasklist(){
$.getJSON( '/controlarea/tasksinfo/' + numberofdays, function(allTasks) {

	populateAllTasks(allTasks);
	
		
	});
};

function otherdays(){
	
	numberofdays = $('#numberofdays').val();
	gettasklist();
	
};

function populateAllTasks(allTasks){


var failedtasks = allTasks['FailedTasks'];

	if(failedtasks.length == 0) {
		failedTaskshtml = "No failed requests";
	};


if(failedtasks.length > 0) {
	
	var failedTaskshtml = '';
	
	for(i=0; i< failedtasks.length; i++){
		
		var failresult = JSON.parse(failedtasks[i].result);
		var typeoferror = failresult['py/object'];
		var errortype = typeoferror;
		if(typeoferror =='controlarea.tasks.ControlareaException'){
			
			errortype = 'Controlarea'
			
		var reduce = failresult['py/reduce'];
		var getmore = reduce[1];
		var ourtuple = getmore['py/tuple'];
		var moreinfo = ourtuple[0];;		
		var taskcategory = moreinfo['category'];
        var tasklabel = moreinfo['label'];
            
            if(tasklabel == 'Test task'){
            	
            	taskstatuslist = ['Test1','Test2','Test3'];
            	
            }
            
            else{
            taskstatuslist = moreinfo['statuslist'];
            }
			var taskrequestpurpose = moreinfo['reqpurpose'];
			var taskuser = moreinfo['user'];
		    var ipuuid = moreinfo['ipuuid'];
			var taskerrorlist = [];
			if(tasklabel == 'Test task'){
				taskerrorlist = 'Some random error';
			}
			else{
				taskerrorlist = moreinfo['errorlist'][0];
			}
				
			//failedTaskshtml =  failedTaskshtml +  'Controlareaexception';
			failedTaskshtml = failedTaskshtml + '<tr><td>'+ failedtasks[i].status + '</td><td>' + 'Controlarea' +  '</td><td>' + '<b>IP UUID: </b>' + ipuuid + '<b> Request purpose: </b>'+ taskrequestpurpose + '<b> Action:</b> ' + tasklabel + '<b> Errorlist: </b> ' + taskerrorlist + '</td></tr>';
			
		}
		
		else{
		//failedTaskshtml =  failedTaskshtml + '<tr><td>' + failedtasks[i].status + '</td><td>' + errortype + '</td><td>' + failedtasks[i].result + '</td></tr>';

		failedTaskshtml = failedTaskshtml + '<tr><td>' + failedtasks[i].status + '</td><td>' + errortype + '</td><td>' + failedtasks[i].result + '</td></tr>';
		}
		
	}	
	
	
	};
	


document.getElementById("failedtasks").innerHTML = failedTaskshtml;

var pendingTaskshtml = '';

var pendingTasks = allTasks['PendingTasks'];


for (i=0; i<pendingtasks.length; i++){

pendingTaskshtml = pendingTaskshtml + '<tr><td>' + pendingTasks[i].status + '</td></tr>';

}

if (pendingTasks.length == 0){
    pendingTaskshtml = "No pending requests";
}

document.getElementById("pendingtasks").innerHTML = pendingTaskshtml;

var progressTaskshtml = '';

var progressTasks = allTasks['ProgressTasks'];

for (i=0; i< progressTasks.length; i++){
var progressinfo = JSON.parse(progressTasks[i].info);
var progressresult = JSON.parse(progressTasks[i].result);
progressTaskshtml = progressTaskshtml + '<tr><td>' + progressinfo['reqpurpose'] + '</td><td></td><td>' + progressinfo['user'] +'</td><td></td><td><progress value=' + progressresult['progress_percent'] + ' max="100"></progress></td></tr>';

}


if (progressTasks.length == 0){

progressTaskshtml = "No requests in progress";
}

document.getElementById("progresstasks").innerHTML = progressTaskshtml;


var successTaskshtml = '';

var successTasks = allTasks['SuccessTasks'];

function getlink(label){

var link = '/controlarea/';
var stage = '';
var stop ='/';

switch(label){
            case 'Check In from Reception':
                stage = 'fromreceptionprogress';
                break;
            case 'Check out to work':
                stage = 'toworkprogress';
                break;
            case 'Check in from work':
                stage = 'fromworkprogress';
                break;
            case  'Check infrom or to gatarea':
            	stage = 'checkouttogateprogress'
                break;
            case 'Diffcheck':
                stage = 'diffcheckprogress';
                break;
            case 'Preserve IP':
                stage = 'preserveprogress';
                break;
            case 'Delete IP':
                stage = 'deleteprogress';
                break;
            default:
                console.log(label);
}
var completelink = link + stage + stop;

return completelink;

}

if (successTasks.length == 0){

	successTaskshtml = "No completed requests";
	}

var controlareaiterator = 0;

for (i=0; i< successTasks.length; i++){

    var theresult = JSON.parse(successTasks[i].result);

    if(theresult['category'] == 'controlarea'){
    
    controlareaiterator = controlareaiterator + 1;

    var controlarealink = getlink(theresult['label']);
    successTaskshtml = successTaskshtml + '<tr><td>' +  theresult['label'] + '</td><td></td><td><a href=' + controlarealink + successTasks[i].taskid + '>'+ theresult['reqpurpose'] + '</a></td><td></td><td>'+ theresult['user'] + '</td><td></td><td> ' + successTasks[i].status + '</td><td></td><td>' + successTasks[i].datedone + '</td></tr>'
        
    }
    }


if (controlareaiterator == 0){

    successTaskshtml = "No completed requests";
    }


document.getElementById("successtasks").innerHTML = successTaskshtml;

}

</script>

{% endblock %}